---
layout: post
title: linux kvm 虚拟化
categories: [cm, linux]
tags: [kvm, qemu, cloud, libvirt]
---

* 参考： 
  * [厨师老六 - 云计算基础-管理KVM宿主服务器](https://www.jianshu.com/p/045c75437e2b)
  * [octetz.com - Linux Hypervisor Setup (libvirt/qemu/kvm)](https://octetz.com/docs/2020/2020-05-06-linux-hypervisor-setup/)
  * [Arch linux - wiki - QEMU](https://wiki.archlinux.org/title/QEMU_\(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87\))
  * []()
  * []()
  * []()
  * []()



## qemu 、KVM

QEMU的缺点是因为是纯软件模拟，所有非常慢。QEMU 1.0的时候有一个QEMU和KVM结合的分支。KVM只是一个内核的模块，没有用户空间的管理工具，KVM的虚拟机可以借助QEMU的管理工具来管理。QEMU也可以借助KVM来加速，提升虚拟机的性能。QEMU-KVM的分支版本发布了3个正式的版本1.1、1.2、1.3，随后和QEMU的主版本合并，也就是说现在的QEMU版本默认支持KVM，QEMU和KVM已经紧密地结合起来了。

KVM的最后一个自己的版本是KVM 83，随后和内核版本一起发布，和内核版本号保持一致，所以要使用KVM的最新版本，就要使用最新的内核。

## Libvirt

Libvirt是一套开源的虚拟化的管理工具，主要由3部分组成：

·一套API的lib库，支持主流的编程语言，包括C、Python、Ruby等。

·Libvirtd服务。

·命令行工具virsh。

Libvirt的设计目标是通过相同的方式管理不同的虚拟化引擎，比如KVM、Xen、HyperV、VMware ESX等。但是目前实际上多数场景使用Libvirt的是KVM，而Xen、HyperV、VMware ESX都有各自的管理工具。

Libvirt可以实现对虚拟机的管理，比如虚拟机的创建、启动、关闭、暂停、恢复、迁移、销毁，以及虚拟机网卡、硬盘、CPU、内存等多种设备的热添加。

Libvirt还支持远程的宿主机管理，只要在宿主机上启动Libvirtd服务并做好配置，就可以通过Libvirt进行虚拟机的配置。通道可以是以下方式：

·SSH。

·TCP。

·基于TCP的TLS。

Libvirt将虚拟机的管理分为以下几个方面：

第一，存储池资源管理，支持本地文件系统目录、裸设备、lvm、nfs、iscsi等方式。在虚拟机磁盘格式上支持qcow2、vmdk、raw等格式。

第二，网络资源管理，支持Linux桥、VLAN、多网卡绑定管理，比较新的版本还支持Open vSwitch。Libvirt还支持nat和路由方式的网络，Libvirt可以通过防火墙让虚拟机通过宿主机建立网络通道，和外部的网络进行通信。



## 开启CPU 虚拟化技术

在BIOS中开启CPU虚拟化技术，intel 的相关名称是 vmx, vt-x, vt-d， AMD 的相关名称是 SVM。

`egrep '(vmx|svm)' /proc/cpuinfo` 有输出内容，说明CPU支持虚拟化。



## 宿主机环境配置


### centos 6.6

~~~sh
[root@localhost ~]# rpm -qa|grep -E 'qemu|libvirt|virt' 

libvirt-client-0.10.2-29.el6.x86_64 
#Libvirt的客户端，最重要的功能之一就是就在宿主机关机时可以通知虚拟机也关机，
#使虚拟机系统正常关机，而不是被强制关机，造成数据丢失

gpxe-roms-qemu-0.9.7-6.10.el6.noarch #虚拟机iPXE的启动固件，支持虚拟机从网络启动

libvirt-python-0.10.2-29.el6.x86_64   #libvirt为Python提供的API
python-virtinst-0.600.0-18.el6.noarch  #一套Python的虚拟机安装工具

qemu-KVM-0.12.1.2-2.415.el6.x86_64 #KVM在用户空间运行的程序

Virt-manager-0.9.0-19.el6.x86_64  #基于 Libvirt 的图像化虚拟机管理软件

libvirt-0.10.2-29.el6.x86_64   #用于管理虚拟机，它提供了一套虚拟机操作API
virt-viewer-0.5.6-8.el6.x86_64  #显示虚拟机的控制台console
virt-top-1.0.4-3.15.el6.x86_64  #类似于top命令，查看虚拟机的资源使用情况
virt-what-1.11-1.2.el6.x86_64  #在虚拟机内部执行，查看虚拟机运行的虚拟化平台

qemu-img-0.12.1.2-2.415.el6.x86_64  #用于操作虚拟机硬盘镜像的创建、查看和格式转化
~~~


### centos 7

~~~sh
[root@KVM-host-CentOS7 ~]# rpm -qa | grep -E 'qemu-img|libvirt-[0-9]|virt-install'
qemu-img-1.5.3-60.el7_0.10.x86_64
virt-install-0.10.0-20.el7.noarch
libvirt-1.1.1-29.el7_0.3.x86_64

[root@KVM-host-CentOS7 ~]# lsmod |grep KVM  #查看KVM模块是否载入
KVM_intel 138567  6 
KVM 441119  1 KVM_intel
~~~

Libvirt还包含了很多工具的库，可以使用`yum install libvirt*`命令安装。

Libvirt及guestfish相关的工具在平时的运维过程中经常会用到，建议使用`yum install libguest* libvirt*`命令安装。










## 入门： 安装环境、创建第一个虚拟机

1. BIOS 开启 CPU 的虚拟化支持。
1. 安装 qemu、libvirt和其他需要的组件

    ~~~
    pacman -Sy --needed \
      qemu \
      dhclient \
      openbsd-netcat \
      virt-viewer \
      libvirt \
      dnsmasq \
      dmidecode \
      ebtables \
      virt-install \
      virt-manager \
      bridge-utils
    ~~~

1. 调整执行权限

    方便 libvirt 的工具 default to `qemu:///system` ，否则缺省使用 `qemu:///session`

    ~~~
    sudo cp -rv /etc/libvirt/libvirt.conf ~/.config/libvirt/ &&\
    sudo chown ${YOURUSER}:${YOURGROUP} ~/.config/libvirt/libvirt.conf
    ~~~

    ~~~
    usermod -a -G polkit,wheel your-user-name
    ~~~

    edit `/etc/polkit-1/rules.d/50-libvirt.rules`

    ~~~
    /* Allow users in wheel group to manage the libvirt
    daemon without authentication */
    polkit.addRule(function(action, subject) {
        if (action.id == "org.libvirt.unix.manage" &&
            subject.isInGroup("wheel")) {
                return polkit.Result.YES;
        }
    });
    ~~~

    修改完，注销重新登陆， 或者重启 libvirtd


1. 配置、启动 libvirtd

    ~~~
    sudo systemctl start libvirtd
    sudo systemctl enable libvirtd
    ~~~

    libvirt keeps its files at `/var/lib/libvirt/`

    `images`目录是 VM磁盘镜像 的默认存放目录。


1. 创建一个虚拟机

    * 使用 `virt-manager` 图形界面创建
        1. 启动 `virt-manager` 出现GUI的管理界面。
        1. 点击 `Create a new virtual machine`
        1. 选择 `Local install media` ，添加新的 Storage Pool 到 存放iso的地方，选中需要的系统安装iso文件
        1. 设置系统的名称、CPU、内存、磁盘、网络（可以先选择 NAT）
        1. 点击 完成 后， virt-viewer 会弹出来现实安装进度。


    * 使用 `virt-install` 安装

        ~~~
        virt-install \
          --name ubuntu1804 \
          --ram 2048 \
          --disk path=/var/lib/libvirt/images/u19.qcow2,size=8 \
          --vcpus 2 \
          --os-type linux \
          --os-variant generic \
          --console pty,target_type=serial \
          --cdrom /var/lib/libvirt/isos/ubuntu-18.04.4-live-server-amd64.iso
        ~~~



## 虚拟机管理： 克隆、备份、恢复

### 查看所有虚拟机

~~~bash
virsh list --all
~~~


### Clone a VM

~~~bash
virt-clone \
  --original ubuntu18.04 \
  --name cloned-ubuntu \
  --file /var/lib/libvirt/images/cu.qcow2
~~~


### 虚拟机的block device 信息

~~~bash
virsh domblklist vm-name
~~~


### 查看虚拟机信息

~~~bash
virsh dominfo vm-name
~~~

### cdrom 操作

Eject : `virsh change-media $VMName --path sda --eject --live`
Insert : `virsh change-media $VMName --path sda --source $ISO --insert --live`




## 其他知识

* [qemu基本架构](https://blog.csdn.net/weixin_45774557/article/details/118574379)
* []()
* []()
* []()
* []()
* []()



在QEMU中`hypervisor: QEMU TCG`，Tiny Code Generator（TCG）将源处理器机器代码转换为虚拟机运行所需的机器代码块。

。在Tiny Code Generator（TCG）中，这些已经翻译的代码块放在转换缓存中，并通过跳转指令将源处理器的指令集（ISA）和目标处理器的指令集（ISA）链接在一起。

`TCG` and `KVM` are entirely separate modes of operation for QEMU. 

If you're using KVM (via -enable-kvm on the command line) then all guest instructions are either natively executed by the host CPU or (for a few instructions mostly doing I/O to emulated devices) emulated inside the host kernel

If you use QEMU in TCG mode (the default) then we are a pure emulator in userspace and make no use of the host CPU's hypervisor functionality. qemu-user-mode is always TCG emulation, and never KVM.




* 安装
安装 qemu，(或 qemu-headless，一个没有GUI的版本）并根据需要安装下面的可选软件包：

qemu-arch-extra - 额外架构支持
qemu-block-gluster - Glusterfs block 支持
qemu-block-iscsi - iSCSI block 支持
qemu-block-rbd - RBD block 支持
samba - SMB/CIFS 服务器支持

非官方的AUR包 `qemu-user-static` AUR 为所有QEMU支持的架构提供了一个带用户模式和静态链接模式的变种。它的预编译版本在这个包中: qemu-user-static-binAUR。 它的QEMU命令依照 qemu-target_architecture-static的规则命名, 例如, qemu-x86_64-static 代表目标架构为intel 64位CPU。

~~~
sudo pacman -S qemu qemu-arch-extra qemu-block-gluster qemu-block-iscsi qemu-block-rbd
sudo pacman -S samba
~~~

qemu 包提供了 x86_64 架构的模拟器， 可以进行全系统模拟 (`qemu-system-x86_64`)。 `qemu-arch-extra` 包提供了 x86_64 用户模式的模拟 (`qemu-x86_64`)。

* **全系统模拟模式 (full-system emulation)**

在该模式下, QEMU将会模拟一个完整的系统，包含一个或多个处理器以及各种外围设备。这种模式更加贴近真实的系统，且这种模式不要求被模拟的客户机系统是Linux，但它的速度较慢。

QEMU中启用full-system模式的命令依照如下规则进行命名 qemu-system-目标机器架构, 例如 qemu-system-x86_64 用于模拟64位intel架构CPU, qemu-system-i386 模拟32位intel架构CPU, qemu-system-arm 模拟ARM架构(32 位), qemu-system-aarch64 模拟ARM架构(64位), 等等。
如果模拟的CPU架构与宿主机的CPU架构相同, 那么即使在此模式下，QEMU仍有可能使用hypervisor(例如KVM or Xen)的技术对模拟机进行加速。

* **用户模式(Usermode emulation)**

在此模式下, QEMU能够利用宿主机的系统资源来调用为其他架构编译的Linux可执行文件



与其他的虚拟化程序如 VirtualBox 和 VMware 不同, QEMU不提供管理虚拟机的GUI（运行虚拟机时出现的窗口除外），也不提供创建具有已保存设置的持久虚拟机的方法。除非您已创建自定义脚本以启动虚拟机，否则必须在每次启动时在命令行上指定运行虚拟机的所有参数。

* 硬盘镜像

  * raw镜像
    和客户机器上看到的内容一模一样，并且将始终使用主机上的来宾硬盘驱动器的全部容量。此方法提供的I / O开销最小，但可能会浪费大量空间，因为guest虚拟机上未使用的空间无法在主机上使用。
  * qcow2 格式
    仅当客户系统实际写入内容的时候，才会分配镜像空间。对客户机器来说，硬盘大小表现为完整大小，即使它可能仅占用主机系统上的非常小的空间。此映像格式还支持QEMU快照功能

~~~bash
# 创建 raw 镜像文件，4G大小
# 用 dd 或 fallocate 也可以创建一个 raw 镜像。
qemu-img create -f raw image_file 4G

# 创建 qcow2 镜像文件，4G大小
qemu-img create -f qcow2 image_file 4G
~~~

创建上层镜像

~~~
qemu-img create -o backing_file=img1.raw,backing_fmt=raw -f qcow2 img1.cow

qemu-system-i386 img1.cow
~~~

调整镜像大小

~~~bash
# 适用于 raw 和 qcow2
# 在磁盘映像扩容后，必须使用虚拟机内部系统的分区工具对该镜像进行分区并格式化后才能真正开始使用新空间。 
# 在收缩磁盘映像时，必须首先使用虚拟机内部系统的分区工具减少分该分区的大小，然后相应地收缩磁盘映像，否则收缩磁盘映像将导致数据丢失！
qemu-img resize disk_image +10G
~~~

安装操作系统

~~~
qemu-system-x86_64 -cdrom iso文件路径 -boot order=d -m 4G -drive file=镜像文件路径,format=raw
~~~

可以用 `-boot menu=on` 代替 `-boot order=d` 启动boot菜单方便调试。

执行出错： `end Kernel panci - not syncing: System is deadlocked on memory`
默认情况下仅分配给虚拟机128MB的内存， 分配的内存大小可以通过 `-m` 调整， 比如 -m 512M 或 -m 2G

运行虚拟化的系统

~~~bash
qemu-system-i386 options disk_image
~~~

`Ctrl+Alt+g` 可以是否鼠标捕获。

启用 KVM

1. BIOS 开启 CPU 的虚拟化支持。
1. `qemu-system-x86_64` 命令加上 `-enable-kvm` 后，虚拟机的运行速度就正常，qemu tcg 模式下速度很慢。
























