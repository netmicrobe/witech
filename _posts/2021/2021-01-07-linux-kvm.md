---
layout: post
title: linux kvm 虚拟化
categories: [cm, linux]
tags: [kvm, qemu, cloud, libvirt]
---

* 参考： 
  * [厨师老六 - 云计算基础-管理KVM宿主服务器](https://www.jianshu.com/p/045c75437e2b)
  * [octetz.com - Linux Hypervisor Setup (libvirt/qemu/kvm)](https://octetz.com/docs/2020/2020-05-06-linux-hypervisor-setup/)
  * []()
  * []()
  * []()
  * []()
  * []()


## 入门： 安装环境、创建第一个虚拟机


1. 安装 qemu、libvirt和其他需要的组件

    ~~~
    pacman -Sy --needed \
      qemu \
      dhclient \
      openbsd-netcat \
      virt-viewer \
      libvirt \
      dnsmasq \
      dmidecode \
      ebtables \
      virt-install \
      virt-manager \
      bridge-utils
    ~~~

1. 调整执行权限

    方便 libvirt 的工具 default to `qemu:///system` ，否则缺省使用 `qemu:///session`

    ~~~
    sudo cp -rv /etc/libvirt/libvirt.conf ~/.config/libvirt/ &&\
    sudo chown ${YOURUSER}:${YOURGROUP} ~/.config/libvirt/libvirt.conf
    ~~~

    ~~~
    usermod -a -G polkit,wheel your-user-name
    ~~~

    edit `/etc/polkit-1/rules.d/50-libvirt.rules`

    ~~~
    /* Allow users in wheel group to manage the libvirt
    daemon without authentication */
    polkit.addRule(function(action, subject) {
        if (action.id == "org.libvirt.unix.manage" &&
            subject.isInGroup("wheel")) {
                return polkit.Result.YES;
        }
    });
    ~~~

    修改完，注销重新登陆， 或者重启 libvirtd


1. 配置、启动 libvirtd

    ~~~
    sudo systemctl start libvirtd
    sudo systemctl enable libvirtd
    ~~~

    libvirt keeps its files at `/var/lib/libvirt/`

    `images`目录是 VM磁盘镜像 的默认存放目录。


1. 创建一个虚拟机

    * 使用 `virt-manager` 图形界面创建
        1. 启动 `virt-manager` 出现GUI的管理界面。
        1. 点击 `Create a new virtual machine`
        1. 选择 `Local install media` ，添加新的 Storage Pool 到 存放iso的地方，选中需要的系统安装iso文件
        1. 设置系统的名称、CPU、内存、磁盘、网络（可以先选择 NAT）
        1. 点击 完成 后， virt-viewer 会弹出来现实安装进度。


    * 使用 `virt-install` 安装

        ~~~
        virt-install \
          --name ubuntu1804 \
          --ram 2048 \
          --disk path=/var/lib/libvirt/images/u19.qcow2,size=8 \
          --vcpus 2 \
          --os-type linux \
          --os-variant generic \
          --console pty,target_type=serial \
          --cdrom /var/lib/libvirt/isos/ubuntu-18.04.4-live-server-amd64.iso
        ~~~



## 虚拟机管理： 克隆、备份、恢复

### 查看现有虚拟机

~~~bash
virsh list --all
~~~


### Clone a VM

~~~bash
virt-clone \
  --original ubuntu18.04 \
  --name cloned-ubuntu \
  --file /var/lib/libvirt/images/cu.qcow2
~~~






































