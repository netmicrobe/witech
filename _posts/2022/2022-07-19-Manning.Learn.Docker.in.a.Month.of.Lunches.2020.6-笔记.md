---
layout: post
title: Manning.Learn.Docker.in.a.Month.of.Lunches.2020.6-笔记，关联 docker-compose
categories: [cm, ]
tags: []
---

* 参考： 
  * [Docker official site](https://www.docker.com/)
  * [wiki.archlinux - Docker](https://wiki.archlinux.org/title/docker)
  * []()
  * []()
  * []()
  * []()
  * []()
  * []()

## 例子

https://github.com/microservices-demo

It’s a great sample application if you want to see how microservices are actually implemented. Each component owns its own data and exposes it through an API. 


## serverless framework

If you’re running in the datacenter, you can host your own platform in Docker using `Nuclio`, `OpenFaaS`, or `Fn Project`, which are all popular open source serverless frameworks.




## 安装

* Docker Desktop
  * Docker Desktop 下载地址： <https://www.docker.com/products/docker-desktop/>
  * macOS Sierra 10.12 及以上版本；
  * Windows 10 及以上

* Docker Toolbox
  * 不能安装 Docker Desktop 的旧版 Windows 和 MacOS。


### Linux 安装

Docker 安装脚本 : <https://get.docker.com/>
Docker Engine : <https://docs.docker.com/engine/install/>
Docker Compose : <https://docs.docker.com/compose/install/>

* arch linux / manjaro

~~~sh
sudo pacman -S docker docker-compose
~~~



## 图形化管理后台

* Portainer ： Open source
* UCP(Universal Control Plane) : commercial



## 配置


### 查看 docker 版本

`docker version` 可以查看 docker Engine Client & Server 的版本信息。

如果看不到 Docker Engine Server，看下service 状态并启动

~~~sh
systemctl status docker.service
sudo systemctl start docker.service
sudo docker version
~~~

`docker-compose version` 可以看到 docker compose 版本信息。




## container 管理

* 容器中的app process 运行，容器运行； app process 退出，容器也退出。
* 停止的容器，不会自动被删除，只能用户自己手动删除。


### 启动容器

~~~sh
# 启动执行目标命令，执行完退出
docker container run diamol/ch02-hello-diamol
~~~

~~~sh
# 通过命令行访问 container
# 执行 `exit` 退出交互命令行，同时 container 也停止。
docker container run --interactive --tty diamol/base
# 或
docker container run -it diamol/base
~~~

~~~sh
# --detach : 命令执行完，container 以 service 方式运行，不退出。
# --publish : 端口映射，宿主机的8088 映射 container 的 80 端口
docker container run --detach --publish 8088:80 diamol/ch02-hello-diamol-web
# 或
docker container run -d -p 8088:80 diamol/ch02-hello-diamol-web
~~~

### 带参数启动

~~~sh
docker container run --env TARGET=google.com diamol/ch03-web-ping
# 或
docker container run -e TARGET=docker.com -e INTERVAL=5000 web-ping
~~~



### 停止的容器

`docker container stop <container-id>`

### 删除容器

`docker container rm <container-id>`

~~~sh
# 删除所有容器
docker container rm --force $(docker container ls --all --quiet)
~~~



### 状态查看 docker ps 或 docker container ls

* refer
  * [docs.docker.com - docker ps](https://docs.docker.com/engine/reference/commandline/ps/)
  * [Ubuntu Manpage: docker-container-ls - List containers](https://manpages.ubuntu.com/manpages/bionic/man1/docker-container-ls.1.html)
  * []()

`docker ps` 等价于 `docker container ls`

~~~sh
# 当前正在运行的container
docker ps
# or
docker container ls

# 所有的container ，无论是否正在运行
docker ps -a
docker container ls -a
docker container ls --all

# -q 参数，表示只打印id
docker ps -q

# 所有停止运行的container
docker ps --filter "status=exited"
~~~

*  the container ID is the same as the hostname inside the container. 


### 容器的详细情况 docker container inspect

~~~sh
docker container inspect <container-id>
~~~


### 容器运行的进程 docker container top

~~~sh
docker container top <container-id>
~~~

### 容器执行的日志 docker container logs

~~~sh
docker container logs <container-id>
~~~

### docker container stats

显示 container 当前占用的 CPU、内存、网络等统计信息。

~~~sh
docker container stats <container-id>
~~~





## image 镜像管理

### 镜像库服务器

镜像库服务器，称为，registries

Docker Hub 是公用镜像库， 地址是 https://hub.docker.com/


### 从 Docker Hub 下载 image

~~~sh
docker image pull diamol/ch03-web-ping
~~~

### 使用 Dockerfile 创建 image

#### 简单的例子

* Dockerfile

~~~
FROM diamol/node
ENV TARGET="blog.sixeyed.com"
ENV METHOD="HEAD"
ENV INTERVAL="3000"
WORKDIR /web-ping
COPY app.js .
CMD ["node", "/web-ping/app.js"]
~~~

`WORKDIR`，创建这个目录，并作为工作目录。
`COPY` ， 将本地文件或文件夹，拷贝到image文件系统中。

* 目录结构

~~~
web-ping
├── app.js
├── Dockerfile
└── README.md
~~~

* build image

~~~sh
cd /some-path/web-ping

# --tag 参数指定 image 的 name
# 最后一个参数，说明build 的 local 目录，点表示当前目录
docker image build --tag web-ping .
~~~

build好的image，被存放在 local image cache

~~~sh
# 在本地 image缓存中，查看w字母开头的image
docker image ls 'w*'
~~~



## 技巧

### docker 清除容器和镜像

~~~sh
docker container rm -f $(docker container ls -aq)

docker image rm -f $(docker image ls -f reference='diamol/*' -q)
~~~













